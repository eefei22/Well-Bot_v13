# Well-Bot · Low-Level Design — Spiritual Quote Feature (MVP)

*Last updated: 2025-10-02 · Store timestamps in UTC (UI: Asia/Kuala_Lumpur).*

## 1) Scope

* Chat: **serve one quote per request**, filtered by user religion with **General** fallback.
* No attribution. Preserve DB text verbatim (multi-sentence allowed).
* **Reflection**: one sentence, generated by LLM (no doctrine, emotion-regulation only).
* **Session cap**: max **3 quotes per session** (`session_id`).
* **Repeat-avoidance**: do not repeat same quote to the same user within **7 days**.
* Interruptions append standard **“Activity interrupted”** card and resume chat.

## 2) Data Model

**wb_quote**
`{ id uuid pk, category enum('islamic','buddhist','christian','hindu','general'), text text }`
Index: `(category)`

**wb_activity_event**
`{ id uuid pk, user_id uuid fk, type 'quote', ref_id uuid, action 'shown', created_at timestamptz }`
Index: `(user_id, created_at desc)`

**wb_quote_seen** (for repeat-avoidance window)
`{ user_id uuid, quote_id uuid, seen_at timestamptz, primary key (user_id, quote_id) }`
Index: `(user_id, seen_at desc)`

> No embeddings are created for quotes.

## 3) Selection Algorithm

Given `user.religion ∈ {islamic,buddhist,christian,hindu,general,null}`:

1. Primary pool = quotes where `category = user.religion` (if null → `general`).
2. Exclude any `quote_id` where `seen_at >= now() - 7 days`.
3. If pool empty → fallback to `category='general'` with same exclusion.
4. If still empty → return info card “No quote available now.” (no error).
5. Pick **random** from remaining pool.

On success:

* Insert/UPSERT into **wb_quote_seen** `(user_id, quote_id, seen_at=now())`.
* Log **wb_activity_event(type='quote', action='shown', ref_id=quote_id)`.

## 4) MCP Tool (Contract)

Global request/response envelopes per project standard.

### `quote.get`

**Args**

```json
{ "reason": "user_request" }
```

**Behavior**

1. Enforce **session cap**: if this `session_id` has already shown **3** quotes → return info card:

   * Title: `Quote limit reached`
   * Body: `You’ve reached the quote limit for this session.`
2. Select quote per **§3**. If none → info card “No quote available now.”
3. Generate **reflection** (LLM, DeepSeek, no reasoning, `temperature=0.3`):

   * One sentence, neutral, supportive, no doctrine, no prescriptions.
   * Examples of acceptable forms:

     * “What part of this feels most relevant to you right now?”
     * “How might this line influence how you show up today?”
4. Return success **card**:

```json
{
  "status": "ok",
  "type": "card",
  "title": "Today’s quote",
  "body": "<DB quote text>\n\nReflection: <one-sentence reflection>",
  "meta": { "kind": "quote" },
  "persisted_ids": { "primary_id": "<quote_id>" },
  "diagnostics": { "tool": "quote.get", "duration_ms": 0 }
}
```

**TTS**: read the quote text, brief pause, then the reflection sentence.

**Errors**

* `DB_READ_FAILED`
* `LLM_REFLECTION_FAILED` (fallback: return quote with a fixed generic reflection: “What part of this speaks to you right now?”)

## 5) Safety & Guardrails

* Spiritual quotes are **emotion-regulation aids**; the assistant **must not** discuss religious doctrine or political topics.
* If the user pivots to religion/politics discussion, reply with the project’s decline template (no card change).
* Run `safety.check` on the **user’s request text**. If triggered → show support card and **do not** serve a quote.

## 6) Cards & UX

* **Success card**: “Today’s quote” + reflection line (no religion label).
* **Limit card**: as in §4.
* **Unavailable card**: “No quote available now.”
* **Interruption card**: standard project copy.
* All confirmations/info must be **visible and audible**.

## 7) Logging

* **wb_activity_event**: `('quote','shown', quote_id)` on success.
* **wb_tool_invocation_log**: record `quote.get` with `status`, `duration_ms`, `error_code?`.
* **wb_safety_event**: when blocked by safety.
  Retention: 30 days.

## 8) Acceptance

* Random-per-request; respects user religion with General fallback.
* Enforces 7-day repeat-avoidance per user.
* Enforces 3-per-session cap; returns limit card when exceeded.
* LLM reflection is one sentence; falls back to generic on LLM failure.
* No attribution; preserves DB text verbatim.
* Safety block prevents serving a quote.
* Activity event logged; quote_seen upserted.
